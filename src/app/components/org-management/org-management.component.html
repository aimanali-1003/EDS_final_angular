<div class="header">
  <h1>Organization Management</h1>
  <button mat-icon-button (click)="toggleSidebar()">
    <mat-icon>{{ sidebarOpen ? 'close' : 'menu' }}</mat-icon>
  </button>
</div>

<div class="overlay" *ngIf="sidebarOpen" (click)="toggleSidebar()"></div>
<div class="sidebar" [@slideInOut]="sidebarOpen ? 'in' : 'out'" [ngClass]="{ 'open': sidebarOpen }">
  <h2>Search Filters</h2>
  <button mat-button class="mat-button-submit" (click)="submitFilters()">
    <mat-icon style="margin-right: 8px;">done_all</mat-icon>Search
  </button>
  <button mat-button class="mat-button-close" (click)="toggleSidebar()">
    <mat-icon style="margin-right: 8px;">cancel</mat-icon>Close
  </button>
</div>

<div class="main-content">
  <ng-container *ngTemplateOutlet="recursiveTreeView; context: { nodes: dataSource, level: 0 }"></ng-container>
</div>

<mat-paginator
  [length]="totalOrganizationLevels"
  [pageSize]="PageSize"
  [pageSizeOptions]="[10, 25, 50, 100]"
  (page)="onPageChange($event)"
></mat-paginator>

<ng-template #recursiveTreeView let-nodes="nodes" let-level="level">
  <mat-tree [dataSource]="nodes" [treeControl]="treeControl">
    <mat-tree-node *matTreeNodeDef="let node; when: hasChild">
      <table class="tree-table">
        <thead>
          <tr>
            <th> </th>
            <th>Code</th>
            <th>Description</th>
            <th>Level Name</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <ng-container *ngIf="node.levelName !== 'UNIT'">
                <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'Toggle ' + node.description"
                  (click)="fetchChildNodes(node)">
                  <mat-icon>{{ node.isExpanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
                </button>
              </ng-container>
            </td>
            <td>{{ node.code }}</td>
            <td>{{ node.description }}</td>
            <td>{{ node.levelName }}</td>
          </tr>
          <tr *ngIf="treeControl.isExpanded(node)">
            <td colspan="3">
              <ng-container *ngTemplateOutlet="recursiveTreeView; context: { nodes: node.children, level: level + 1 }"></ng-container>
              <mat-paginator
                *ngIf="level === 0"
                [length]="totalCount"
                [pageSize]="PageSize"
                [pageSizeOptions]="[10, 25, 50, 100]"
                (page)="onPageChangeRollup($event)"
              ></mat-paginator>
              <mat-paginator
              *ngIf="level === 1"
              [length]="totalCount"
              [pageSize]="PageSize"
              [pageSizeOptions]="[10, 25, 50, 100]"
              (page)="onPageChangeRollup($event)"
            ></mat-paginator>
            <mat-paginator
            *ngIf="level === 2"
            [length]="totalCount"
            [pageSize]="PageSize"
            [pageSizeOptions]="[10, 25, 50, 100]"
            (page)="onPageChangeRollup($event)"
          ></mat-paginator>
          <mat-paginator
          *ngIf="level === 3"
          [length]="totalCount"
          [pageSize]="PageSize"
          [pageSizeOptions]="[10, 25, 50, 100]"
          (page)="onPageChangeRollup($event)"
        ></mat-paginator>
            </td>
          </tr>
        </tbody>
      </table>
    </mat-tree-node>
  </mat-tree>
</ng-template>
